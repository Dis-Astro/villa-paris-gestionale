import { PrismaClient } from '@prisma/client'
import { NextResponse } from 'next/server'

const prisma = new PrismaClient()
// CREA UN NUOVO EVENTO
export async function POST(req: Request) {
  try {
    const body = await req.json()

    // Cerca cliente esistente (tramite email)
    let cliente = await prisma.cliente.findUnique({
      where: { email: body.clienteEmail }
    })

    // Se non esiste, lo crea
    if (!cliente) {
      cliente = await prisma.cliente.create({
        data: {
          nome: body.clienteNome,
          email: body.clienteEmail
        }
      })
    }

    // Crea l'evento collegato al cliente
    const evento = await prisma.evento.create({
      data: {
        tipo: body.tipo,
        titolo: body.titolo,
        dateProposte: JSON.stringify(body.dateProposte), // array di date (es: ["2025-06-01", "2025-06-02"])
        dataConfermata: body.dataConfermata ? new Date(body.dataConfermata) : null,
        fascia: body.fascia,
        personePreviste: body.personePreviste ? parseInt(body.personePreviste) : null,
        stato: body.stato ?? 'in_attesa',
        note: body.note ?? '',
        clienteId: cliente.id
      },
      include: { cliente: true }
    })

    return NextResponse.json(evento)

  } catch (error) {
    console.error('Errore creazione evento:', error)
    return new NextResponse('Errore nel salvataggio dell\'evento', { status: 500 })
  }
}
// RECUPERA TUTTI GLI EVENTI O UNO SINGOLO SE SPECIFICATO L'ID
export async function GET(req: Request) {
  try {
    const { searchParams } = new URL(req.url)
    const id = searchParams.get('id')

    if (id) {
      const evento = await prisma.evento.findUnique({
        where: { id: Number(id) },
        include: { cliente: true }
      })

      if (!evento) {
        return new NextResponse('Evento non trovato', { status: 404 })
      }

      return NextResponse.json(evento)
    }

    // Recupera tutti gli eventi, ordinati per data confermata (se esiste)
    const eventi = await prisma.evento.findMany({
      orderBy: { dataConfermata: 'asc' },
      include: { cliente: true }
    })

    return NextResponse.json(eventi)

  } catch (error) {
    console.error('Errore nel recupero eventi:', error)
    return new NextResponse('Errore durante il recupero degli eventi', { status: 500 })
  }
}

// MODIFICA UN EVENTO ESISTENTE
export async function PUT(req: Request) {
  try {
    const { searchParams } = new URL(req.url)
    const id = Number(searchParams.get('id'))

    if (!id) {
      return new NextResponse('ID mancante', { status: 400 })
    }

    const body = await req.json()

    const updated = await prisma.evento.update({
      where: { id },
      data: {
        tipo: body.tipo,
        titolo: body.titolo,
        dataEvento: new Date(body.dataEvento),
        fascia: body.fascia,
        clienteNome: body.clienteNome,
        clienteEmail: body.clienteEmail,
        personePreviste: body.personePreviste ? parseInt(body.personePreviste) : null,
        stato: body.stato ?? 'in_attesa',
        note: body.note ?? ''
      }
    })

    return NextResponse.json(updated)
  } catch (error) {
    console.error('Errore modifica evento:', error)
    return new NextResponse('Errore durante la modifica', { status: 500 })
  }
}

// ELIMINA UN EVENTO
export async function DELETE(req: Request) {
  try {
    const { searchParams } = new URL(req.url)
    const id = Number(searchParams.get('id'))

    if (!id) {
      return new NextResponse('ID mancante', { status: 400 })
    }

    const deleted = await prisma.evento.delete({
      where: { id }
    })

    return NextResponse.json(deleted)
  } catch (error) {
    console.error('Errore eliminazione evento:', error)
    return new NextResponse('Errore durante l\'eliminazione', { status: 500 })
  }
}
